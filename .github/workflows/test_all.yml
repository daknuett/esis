name: Test

on: push

env:
  SLURM_CONF: /usr/local/etc/slurm.conf

jobs:
  install-slurm:
    runs-on: ubuntu-latest
    steps:
      - name: get slurm configfiles
        uses: actions/checkout@v3
        with: 
          repository: daknuett/esis
          path: esis_for_configfiles
          branch: github_actions

      - name: install slurm
        run: |
          sudo apt-get update
          sudo apt-get install -y slurm-wlm
          cat esis_for_configfiles/.github/workflows/assets/slurm.conf | sed -e "s/main-kek/$(hostname)/" > esis_for_configfiles/.github/workflows/assets/slurm.conf
          cat esis_for_configfiles/.github/workflows/assets/slurm.conf
          sudo cp esis_for_configfiles/.github/workflows/assets/slurm.conf $SLURM_CONF
          sudo cp esis_for_configfiles/.github/workflows/assets/cgroup.conf /usr/local/etc/cgroup.conf
          #mkdir -p /usr/local/lib/slurm/
          #ln -s /usr/lib64/slurm/auth_munge.so /usr/local/lib/slurm/auth_munge.so 

      - name: start slurm
        run: |
          echo "slurmctld..."
          sudo slurmctld $SLURMCTLD_OPTIONS
          echo "slurmd..."
          sudo slurmd -d /usr/local/sbin/slurmstepd $SLURMD_OPTIONS
          echo "sinfo..."
          sinfo


